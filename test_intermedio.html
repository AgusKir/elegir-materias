<!DOCTYPE html>
<html>
<head>
    <title>Test Intermedio Priority</title>
</head>
<body>
    <h1>Testing intermediate priority calculation</h1>
    <pre id="output"></pre>
    
    <script src="http://localhost:8080/classes.js"></script>
    <script>
        // Test setup from the issue - CORRECTED to NOT include 902
        const completedSubjects = [
            3621, 3622, 3623, 3624, 3625, 3626, 3627, 3628, 3629, 3630,
            3631, 3632, 3633, 3634, 3635, 3636, 3637, 3638, 3639, 3640,
            3642, 3643, 3645, 3649, 3651, 901, 911
        ];
        
        const plan = new PlanDeEstudios();
        plan.cargarMateriasDesdeTexto(listado, completedSubjects);
        plan.cargarNombresDesdeTexto(tabla_nombres);
        plan.calcularYGuardarLongitudes(2); // Segundo cuatrimestre
        
        console.log('BEFORE intermediate priority adjustment:');
        console.log('903 valor_corchete:', plan.datos_materias[903]?.valor_corchete);
        console.log('902 valor_corchete:', plan.datos_materias[902]?.valor_corchete);
        console.log('3676 valor_corchete:', plan.datos_materias[3676]?.valor_corchete);
        console.log('3656 valor_corchete:', plan.datos_materias[3656]?.valor_corchete);
        
        // Aplicar ajuste de prioridad intermedia
        const intermedioIds = new Set();
        for (let i = 3621; i <= 3655; i++) {
            intermedioIds.add(i);
        }
        intermedioIds.add(3675);
        intermedioIds.add(3676);
        intermedioIds.add(901);
        intermedioIds.add(902);
        
        // Encontrar el máximo valor_corchete entre las materias intermedias
        let maxIntermedioValor = 0;
        for (const [id, datos] of Object.entries(plan.datos_materias)) {
            const idNum = parseInt(id);
            if (intermedioIds.has(idNum) && plan.materias[idNum]) {
                maxIntermedioValor = Math.max(maxIntermedioValor, datos.valor_corchete);
            }
        }
        
        console.log('Max intermedio valor_corchete:', maxIntermedioValor);
        
        // Ajustar valor_corchete de materias NO intermedias
        for (const [id, datos] of Object.entries(plan.datos_materias)) {
            const idNum = parseInt(id);
            if (!intermedioIds.has(idNum) && plan.materias[idNum]) {
                datos.valor_corchete = datos.valor_corchete + maxIntermedioValor;
            }
        }
        
        console.log('AFTER intermediate priority adjustment:');
        console.log('903 valor_corchete:', plan.datos_materias[903]?.valor_corchete);
        console.log('902 valor_corchete:', plan.datos_materias[902]?.valor_corchete);
        console.log('3676 valor_corchete:', plan.datos_materias[3676]?.valor_corchete);
        console.log('3656 valor_corchete:', plan.datos_materias[3656]?.valor_corchete);
        
        // Expected results from the issue
        const expected = {
            3644: 1,
            3650: 1,
            3647: 2,
            3648: 2,
            3654: 2,
            3641: 3,
            3646: 3,
            3675: 5,
            3676: 5,
            3656: 8,
            903: 9,
            3662: 10
        };
        
        // Get actual results
        let output = 'Subject | Expected | Actual | Match?\n';
        output += '--------|----------|--------|-------\n';
        
        for (const [id, expectedValue] of Object.entries(expected)) {
            const actual = plan.datos_materias[id];
            const actualValue = actual ? actual.valor_corchete : 'N/A';
            const match = actualValue === expectedValue ? '✓' : '✗';
            output += `${id.padEnd(7)} | ${String(expectedValue).padEnd(8)} | ${String(actualValue).padEnd(6)} | ${match}\n`;
        }
        
        output += '\n\nAll remaining subjects sorted by valor_corchete:\n';
        output += 'ID    | Name                                           | valor_corchete | cuatrimestre\n';
        output += '------|------------------------------------------------|----------------|-------------\n';
        
        const sortedSubjects = Object.entries(plan.datos_materias)
            .filter(([id]) => plan.materias[id])
            .sort((a, b) => a[1].valor_corchete - b[1].valor_corchete);
        
        for (const [id, data] of sortedSubjects) {
            const nombre = plan.materias[id].nombre || '';
            output += `${id.padEnd(5)} | ${nombre.padEnd(46)} | ${String(data.valor_corchete).padEnd(14)} | ${data.cuatrimestre}\n`;
        }
        
        document.getElementById('output').textContent = output;
    </script>
</body>
</html>
